<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB - Tu Crédito con Garantía Inmobiliaria</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Calibri', sans-serif; /* Changed font to Calibri */
            background-color: #f3f4f6; /* Light gray background */
            color: #374151; /* Dark gray text */
        }
        .container {
            max-width: 1200px; /* Increased max width for main content */
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #d1d5db; /* Light gray track */
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            border-radius: 9999px; /* Fully rounded track */
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #2563eb; /* Blue thumb */
            cursor: pointer;
            border-radius: 50%; /* Circular thumb */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #2563eb; /* Blue thumb */
            cursor: pointer;
            border-radius: 50%; /* Circular thumb */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        /* Custom scrollbar for table on smaller screens */
        .table-container {
            overflow-x: auto;
            overflow-y: auto; /* Added for vertical scrolling */
            max-height: 400px; /* Added a max-height to enable vertical scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px; /* Added width for vertical scrollbar */
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 9999px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 9999px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-group input[type="number"] {
            width: 80px; /* Adjust width as needed */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
        }
        /* Collapsible section styling */
        .collapsible-content {
            max-height: 1000px; /* Arbitrarily large value for expanded state */
            overflow-y: auto; /* Changed from hidden to auto for vertical scrolling */
            transition: max-height 0.5s ease-out;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            overflow-y: hidden; /* Ensure hidden when collapsed */
        }
        .toggle-button {
            transition: transform 0.3s ease-in-out;
        }
        .toggle-button.rotated {
            transform: rotate(180deg);
        }

        /* Styles for section separation */
        .client-section {
            background-color: #ffffff; /* White background for client section */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            padding: 1.5rem 2rem; /* p-6 sm:p-8 md:p-10 */
            margin-bottom: 2rem; /* mb-8 */
        }

        .lender-section {
            background-color: #f0f4f8; /* Slightly darker background for lender section */
            border-top: 4px solid #2563eb; /* Strong blue top border */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            padding: 1.5rem 2rem; /* p-6 sm:p-8 md:p-10 */
            margin-top: 2rem; /* mt-8 */
        }
        /* Specific styling for panel sliders and inputs */
        .panel-slider-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
            /* Removed align-items: center; to allow text-align: left on panel-value-display */
        }
        .panel-slider-group .input-group {
            width: 100%; /* Make input group take full width */
        }
        .panel-slider-group input[type="range"] {
            flex-grow: 1; /* Allow range input to take available space */
            margin-right: 10px; /* Space between slider and number input */
        }
        .panel-slider-group input[type="number"] {
            width: 80px; /* Fixed width for number input */
            flex-shrink: 0; /* Prevent shrinking */
        }
        .panel-value-display {
            text-align: left; /* Aligned to left */
            margin-top: 0.5rem;
            font-weight: bold;
            color: #4b5563; /* text-gray-700 */
            display: block; /* Ensure it takes full width for text-align to work */
            padding-left: 5px; /* Small padding to align with slider start */
        }
        .slider-box {
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem; /* p-3 */
            margin-bottom: 1rem; /* mb-4 */
            background-color: #ffffff; /* White background */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* subtle shadow */
        }

        /* Removed sticky-panel-header styles as it's no longer needed */
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Removed Header -->

    <main class="flex-grow p-4 sm:p-6 md:p-8">
        <div class="container mx-auto">
            <!-- Client Section -->
            <div class="client-section">
                <!-- Simulador Section -->
                <section id="simulador" class="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
                    <h2 class="text-3xl sm:text-4xl font-bold text-center text-gray-700 mb-6 sm:mb-8">Simulador de Créditos con Garantía Inmobiliaria</h2>
                    <p class="text-lg text-gray-700 mb-8 text-center">Ajusta los parámetros y descubre la cuota estimada para tu crédito.</p>

                    <!-- Input Section -->
                    <section class="mb-8 p-6 bg-blue-100 rounded-lg shadow-inner">
                        <h2 class="text-2xl font-semibold text-gray-900 mb-4">Parámetros del Crédito</h2>

                        <div class="mb-6">
                            <label for="loanAmount" class="block text-gray-700 text-lg font-medium mb-2">Monto del Préstamo (USD)</label>
                            <input type="range" id="loanAmount" min="20000" max="100000" value="100000" step="1000"
                                   class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-sm text-gray-600 mt-2">
                                <span>USD 20.000</span>
                                <span id="loanAmountValue" class="font-semibold text-gray-700">USD 100.000</span>
                                <span>USD 100.000</span>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label for="loanTerm" class="block text-gray-700 text-lg font-medium mb-2">Plazo (Años)</label>
                            <input type="range" id="loanTerm" min="2" max="10" value="10" step="1"
                                   class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-sm text-gray-600 mt-2">
                                <span>2 Años</span>
                                <span id="loanTermValue" class="font-semibold text-gray-700">10 Años</span>
                                <span>10 Años</span>
                            </div>
                        </div>
                    </section>

                    <!-- Unified Output Section -->
                    <section class="mb-8 p-6 bg-blue-100 rounded-lg shadow-inner">
                        <h2 class="text-2xl font-semibold text-gray-900 mb-4">Resultados de tu Simulación</h2>
                        <div class="grid grid-cols-1 gap-4">
                            <!-- Monto Total del Préstamo & Cuota Mensual Estimada -->
                            <div class="bg-white p-4 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                <div class="mb-2 sm:mb-0">
                                    <p class="text-gray-700 text-sm">Monto Total del Préstamo</p>
                                    <p id="totalLoanAmount" class="text-2xl font-bold text-gray-600 mt-1"></p>
                                </div>
                                <div class="sm:text-right">
                                    <p class="text-gray-700 text-sm">Cuota Mensual Estimada</p>
                                    <p id="monthlyPayment" class="text-2xl font-bold text-gray-600 mt-1"></p>
                                </div>
                            </div>
                            <!-- Ingresos Mensuales Requeridos & Valor Mínimo de la Propiedad -->
                            <div class="bg-white p-4 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                <div class="mb-2 sm:mb-0">
                                    <p class="text-gray-700 text-sm">Ingresos Mensuales Requeridos</p>
                                    <p id="minMonthlyIncome" class="text-2xl font-bold text-gray-600 mt-1"></p>
                                </div>
                                <div class="sm:text-right">
                                    <p class="text-gray-700 text-sm">Valor Mínimo de la Propiedad</p>
                                    <p id="minPropertyValue" class="text-2xl font-bold text-gray-600 mt-1"></p>
                                </div>
                            </div>
                            <!-- TNA & CFTEA -->
                            <div class="bg-white p-4 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                <div class="mb-2 sm:mb-0">
                                    <p class="text-gray-700 text-sm">TNA (Tasa Nominal Anual)</p>
                                    <p id="tnaDisplay" class="text-2xl font-bold text-gray-600 mt-1"></p>
                                </div>
                                <div class="sm:text-right">
                                    <p class="text-gray-700 text-sm">CFTEA</p>
                                    <p id="cfteaWithoutOrigination" class="text-2xl font-bold text-gray-600 mt-1"></p>
                                </div>
                            </div>
                        </div>
                        <p id="originationCostsDisplay" class="text-gray-700 text-sm mt-4 text-center">
                            *Gastos estimados de otorgamiento: <span class="font-bold" id="originationCosts"></span> (se pagan por única vez al momento del desembolso, incluyen impuestos y honorarios de escribanía, CFTEA: <span id="cftWithOriginationDisplay"></span>)
                        </p>
                        <div class="mt-6 flex flex-col sm:flex-row justify-center gap-4">
                            <button id="toggleAmortizationTable" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                                Ver Cuadro de Amortización Completo
                            </button>
                        </div>
                    </section>

                    <!-- Amortization Table Section - Collapsible -->
                    <section id="amortizationTableSection" class="mb-8 p-6 bg-blue-100 rounded-lg shadow-inner collapsible-content collapsed">
                        <h2 class="text-2xl font-semibold text-gray-900 mb-4" id="amortizationTableTitle" style="display: none;">Detalle del Cuadro de Amortización</h2>
                        <div class="table-container rounded-lg shadow-md">
                            <table class="min-w-full divide-y divide-blue-200 table-fixed">
                                <thead class="bg-blue-200">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg w-1/9">Fecha de Pago</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-1/9">Nro. Cuota</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-1/9">Saldo Deudor</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-1/9">Pago Capital</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-1/9">Pago Intereses</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-1/9">Seguro Vida</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-1/9">Seguro Incendio y Admin.</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-1/9">IVA</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-1/9">Pago Total</th>
                                    </tr>
                                </thead>
                                <tbody id="amortizationTableBody" class="bg-white divide-y divide-blue-200">
                                    <!-- Rows will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="downloadAmortizationCsvBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                                Descargar Cuadro de Amortización (CSV)
                            </button>
                        </div>
                    </section>
                </section>
            </div>

            <!-- Lender Section -->
            <div class="lender-section">
                <!-- Panel de Control (Políticas Crediticias) - Collapsible -->
                <section class="p-6 bg-blue-50 rounded-lg shadow-inner">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4 flex justify-between items-center cursor-pointer" id="toggleDashboardBottom">
                        Panel de Control (Políticas Crediticias)
                        <button class="text-gray-700 hover:text-gray-900 focus:outline-none toggle-button">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </h2>
                <div id="dashboardContentBottom" class="collapsible-content"> <!-- Removed 'collapsed' class here -->
                    <p class="text-sm text-gray-700 mb-6">Ajusta los parámetros de la política crediticia y los costos para ver su impacto en la simulación.</p>
                    
                    <!-- CFTEA and IRR Display -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div class="bg-white p-4 rounded-lg shadow-md text-center">
                            <p class="text-gray-700 text-lg font-bold mb-2">CFTEA*</p>
                            <span id="cftWithOriginationDisplayPanel" class="font-extrabold text-gray-700 text-3xl"></span>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md text-center">
                            <p class="block text-gray-700 text-lg font-bold mb-2">IRR</p>
                            <span id="bbTIRValue" class="font-extrabold text-gray-700 text-3xl"></span>
                        </div>
                    </div>
                    
                    <!-- Group: Parámetros del crédito -->
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 mt-4">Parámetros del crédito</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div class="slider-box">
                            <label for="dashboardLTV" class="block text-gray-700 text-base font-medium mb-2">Loan-to-Value (LTV)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardLTV" min="0" max="1.00" value="0.50" step="0.01"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardLTVInput" min="0" max="1.00" value="0.50" step="0.01" class="text-right">
                            </div>
                            <span id="dashboardLTVValueDisplay" class="panel-value-display"></span>
                        </div>
                        <div class="slider-box">
                            <label for="dashboardDTI" class="block text-gray-700 text-base font-medium mb-2">Debt-to-Income (DTI)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardDTI" min="0" max="1.00" value="0.30" step="0.01"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardDTIInput" min="0" max="1.00" value="0.30" step="0.01" class="text-right">
                            </div>
                            <span id="dashboardDTIValueDisplay" class="panel-value-display"></span>
                        </div>
                        <div class="slider-box col-span-full"> <!-- Changed to col-span-full -->
                            <label for="dashboardTNA" class="block text-gray-700 text-base font-medium mb-2">TNA (Tasa Nominal Anual)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardTNA" min="0" max="0.30" value="0.135" step="0.001"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardTNAInput" min="0" max="0.30" value="0.135" step="0.001" class="text-right">
                            </div>
                            <span id="dashboardTNAValueDisplay" class="panel-value-display"></span>
                        </div>
                    </div>

                    <!-- Group: Gastos Otorgamiento -->
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Gastos de Otorgamiento</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div class="slider-box">
                            <label for="dashboardEscrituraPercentage" class="block text-gray-700 text-base font-medium mb-2">Gastos de Escribanía (%)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardEscrituraPercentage" min="0" max="0.10" value="0.03" step="0.001"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardEscrituraPercentageInput" min="0" max="0.10" value="0.03" step="0.001" class="text-right">
                            </div>
                            <span id="dashboardEscrituraPercentageValueDisplay" class="panel-value-display"></span>
                        </div>
                        <div class="slider-box">
                            <label for="dashboardEscrituraMinUSD" class="block text-gray-700 text-base font-medium mb-2">Mínimo Gastos de Escribanía (USD)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardEscrituraMinUSD" min="0" max="5000" value="1000" step="100"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardEscrituraMinUSDInput" min="0" max="5000" value="1000" step="100" class="text-right">
                            </div>
                            <span id="dashboardEscrituraMinUSDValueDisplay" class="panel-value-display"></span>
                        </div>
                        <div class="slider-box">
                            <label for="dashboardOriginationFeePercentage" class="block text-gray-700 text-base font-medium mb-2">Fee de Originación (%)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardOriginationFeePercentage" min="0" max="0.10" value="0.02" step="0.001"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardOriginationFeePercentageInput" min="0" max="0.10" value="0.02" step="0.001" class="text-right">
                            </div>
                            <span id="dashboardOriginationFeePercentageValueDisplay" class="panel-value-display"></span>
                        </div>
                        <div class="slider-box">
                            <label for="dashboardOriginationFeeMinUSD" class="block text-gray-700 text-base font-medium mb-2">Mínimo Fee de Originación (USD)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardOriginationFeeMinUSD" min="0" max="5000" value="500" step="100"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardOriginationFeeMinUSDInput" min="0" max="5000" value="500" step="100" class="text-right">
                            </div>
                            <span id="dashboardOriginationFeeMinUSDValueDisplay" class="panel-value-display"></span>
                        </div>
                    </div>

                    <!-- Group: Seguros -->
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Seguros</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div class="slider-box">
                            <label for="dashboardInsuranceLife" class="block text-gray-700 text-base font-medium mb-2">Seguro de Vida (%)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardInsuranceLife" min="0" max="0.01" value="0.001" step="0.0001"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardInsuranceLifeInput" min="0" max="0.01" value="0.001" step="0.0001" class="text-right">
                            </div>
                            <span id="dashboardInsuranceLifeValueDisplay" class="panel-value-display"></span>
                        </div>
                        <div class="slider-box">
                            <label for="dashboardMarkupLifePercentage" class="block text-gray-700 text-base font-medium mb-2">Mark-up Seguro de Vida (%)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardMarkupLifePercentage" min="0" max="1.00" value="0.50" step="0.01"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardMarkupLifePercentageInput" min="0" max="1.00" value="0.50" step="0.01" class="text-right">
                            </div>
                            <span id="dashboardMarkupLifePercentageValueDisplay" class="panel-value-display"></span>
                        </div>
                        <div class="slider-box">
                            <label for="dashboardInsuranceFire" class="block text-gray-700 text-base font-medium mb-2">Seguro de Incendio (%)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardInsuranceFire" min="0" max="0.01" value="0.0002" step="0.0001"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardInsuranceFireInput" min="0" max="0.01" value="0.0002" step="0.0001" class="text-right">
                            </div>
                            <span id="dashboardInsuranceFireValueDisplay" class="panel-value-display"></span>
                        </div>
                        <div class="slider-box">
                            <label for="dashboardMarkupFirePercentage" class="block text-gray-700 text-base font-medium mb-2">Mark-up Seguro de Incendio (%)</label>
                            <div class="input-group">
                                <input type="range" id="dashboardMarkupFirePercentage" min="0" max="1.00" value="0.50" step="0.01"
                                       class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="dashboardMarkupFirePercentageInput" min="0" max="1.00" value="0.50" step="0.01" class="text-right">
                            </div>
                            <span id="dashboardMarkupFirePercentageValueDisplay" class="panel-value-display"></span>
                        </div>
                    </div>

                    <!-- Group: Servicing Fee -->
                    <div class="slider-box col-span-full">
                        <label for="dashboardServicingFee" class="block text-gray-700 text-base font-medium mb-2">Servicing Fee (USD/mes)</label>
                        <div class="input-group">
                            <input type="range" id="dashboardServicingFee" min="0" max="30" value="20" step="1"
                                   class="h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                            <input type="number" id="dashboardServicingFeeInput" min="0" max="30" value="20" step="1" class="text-right">
                        </div>
                        <span id="dashboardServicingFeeValueDisplay" class="panel-value-display"></span>
                    </div>

                    <div class="text-center mt-4">
                        <button id="downloadBBCashFlowCsvBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                            Descargar Flujo de Pagos (CSV)
                        </button>
                    </div>
                </div>
                </section>

            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-6 text-center mt-8 shadow-inner">
        <div class="container mx-auto">
            <p>&copy; 2025 BB. Todos los derechos reservados.</p>
            <p class="mt-2 text-sm">
                <a href="#" class="hover:text-blue-400 transition duration-300">Política de Privacidad</a> |
                <a href="#" class="hover:text-blue-400 transition duration-300">Términos y Condiciones</a>
            </p>
        </div>
    </footer>

    <script>
        // --- Dashboard Adjustable Variables (Policy & Costs) ---
        // These variables will be linked to the dashboard controls.
        let currentTNA = 0.135; // Tasa Nominal Anual (13.5%)
        let currentLTV = 0.50;  // Loan-to-Value (Hasta 50%)
        let currentDTI = 0.30;  // Debt-to-Income (Hasta 30%)
        let currentEscrituraPercentage = 0.03; // New: Gastos de Escritura (3%)
        let currentEscrituraMinUSD = 1000; // New: Mínimo Gastos de Escritura (USD 1000)
        let currentOriginationFeePercentage = 0.02; // New: Fee de Originación (2%)
        let currentOriginationFeeMinUSD = 500; // New: Mínimo Fee de Originación (USD 500)
        let currentInsuranceLifePercentage = 0.001; // 0.1% del saldo deudor
        let currentMarkupLifePercentage = 0.50; // New: Markup Seguro de Vida (50%)
        let currentInsuranceFirePercentage = 0.0002; // 0.02% + IVA sobre valor estimado del inmueble
        let currentMarkupFirePercentage = 0.50; // New: Markup Seguro de Incendio (50%)
        let currentServicingFeeUSD = 20; // USD 20 + IVA por mes
        const IVA_RATE = 0.21; // 21% (fixed as per prompt, unless explicitly requested to be adjustable)

        // Global variable to store amortization data for CSV downloads
        let globalAmortizationData = [];
        let globalBBCashFlowData = []; // New global variable to store BB's cash flow for CSV
        let tempAmortizationDataForCFTEA = []; // Declared globally

        // Declare variables globally
        let loanAmountSlider, loanAmountValueSpan, loanTermSlider, loanTermValueSpan;
        let monthlyPaymentSpan, minMonthlyIncomeSpan, minPropertyValueSpan;
        let cfteaWithoutOriginationSpan, cftWithOriginationDisplay;
        let totalLoanAmountSpan, originationCostsSpan, originationCostsDisplay, tnaDisplaySpan;
        let amortizationTableBody;
        let toggleDashboardBottomButton, dashboardContentBottom;
        let dashboardTNASlider, dashboardTNAInput, dashboardTNAValueDisplay; // Added ValueDisplay
        let dashboardLTVSlider, dashboardLTVInput, dashboardLTVValueDisplay; // Added ValueDisplay
        let dashboardDTISlider, dashboardDTIInput, dashboardDTIValueDisplay; // Added ValueDisplay
        let dashboardEscrituraPercentage, dashboardEscrituraPercentageInput, dashboardEscrituraPercentageValueDisplay; // Added ValueDisplay
        let dashboardEscrituraMinUSD, dashboardEscrituraMinUSDInput, dashboardEscrituraMinUSDValueDisplay; // Added ValueDisplay
        let dashboardOriginationFeePercentage, dashboardOriginationFeePercentageInput, dashboardOriginationFeePercentageValueDisplay; // Added ValueDisplay
        let dashboardOriginationFeeMinUSD, dashboardOriginationFeeMinUSDInput, dashboardOriginationFeeMinUSDValueDisplay; // Added ValueDisplay
        let dashboardInsuranceLifeSlider, dashboardInsuranceLifeInput, dashboardInsuranceLifeValueDisplay; // Added ValueDisplay
        let dashboardMarkupLifePercentage, dashboardMarkupLifePercentageInput, dashboardMarkupLifePercentageValueDisplay; // Added ValueDisplay
        let dashboardInsuranceFireSlider, dashboardInsuranceFireInput, dashboardInsuranceFireValueDisplay; // Added ValueDisplay
        let dashboardMarkupFirePercentage, dashboardMarkupFirePercentageInput, dashboardMarkupFirePercentageValueDisplay; // Added ValueDisplay
        let dashboardServicingFeeSlider, dashboardServicingFeeInput, dashboardServicingFeeValueDisplay; // Added ValueDisplay
        let toggleAmortizationTableButton, amortizationTableSection, amortizationTableTitle, downloadAmortizationCsvBtn;
        let bbTIRValue; // Added for BB's TIR display
        let downloadBBCashFlowCsvBtn; // Added for BB's cash flow CSV download button
        let cftWithOriginationDisplayPanel; // New span for CFTEA in panel


        // --- Helper Functions ---

        /**
         * Formats a number as USD currency, rounding up to the nearest whole number.
         * @param {number} amount - The number to format.
         * @returns {string} Formatted currency string.
         */
        function formatCurrency(amount) {
            const roundedAmount = Math.ceil(amount);
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(roundedAmount);
        }

        /**
         * Formats a number as a percentage.
         * @param {number} value - The number (e.g., 0.135 for 13.5%).
         * @returns {string} Formatted percentage string.
         */
        function formatPercentage(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        /**
         * Calculates the monthly payment for a French amortization system loan.
         * @param {number} principal - Loan principal.
         * @param {number} annualRate - Annual interest rate (e.g., 0.135).
         * @param {number} years - Loan term in years.
         * @returns {number} Monthly payment.
         */
        function calculateFrenchMonthlyPayment(principal, annualRate, years) {
            const monthlyRate = annualRate / 12;
            const numberOfPayments = years * 12;

            if (monthlyRate === 0) {
                return principal / numberOfPayments; // Handle zero interest rate
            }

            return principal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
        }

        /**
         * Calculates the Internal Rate of Return (IRR) for a series of cash flows using the bisection method.
         * Returns a monthly rate.
         * @param {Array<number>} cashFlows - An array of cash flows, where cashFlows[0] is the initial disbursement (positive)
         * and subsequent values are periodic payments (negative).
         * @returns {number} The monthly IRR. Returns 0 if no valid IRR is found within the tolerance.
         */
        function calculateIRR(cashFlows) {
            const maxIterations = 1000;
            const tolerance = 0.00001; // 0.001%
            let lowRate = -0.99; // Lower bound for monthly rate (-99%)
            let highRate = 1.0; // Upper bound for monthly rate (100%)

            // Function to calculate Net Present Value (NPV)
            function npv(rate) {
                let sum = 0;
                for (let i = 0; i < cashFlows.length; i++) {
                    if (1 + rate <= 0 && i > 0) return Infinity;
                    sum += cashFlows[i] / Math.pow(1 + rate, i);
                }
                return sum;
            }

            let npvLow = npv(lowRate);
            let npvHigh = npv(highRate);

            if (npvLow * npvHigh > 0) {
                lowRate = 0;
                highRate = 0.1;
                npvLow = npv(lowRate);
                npvHigh = npv(highRate);
                if (npvLow * npvHigh > 0) {
                    return 0;
                }
            }

            for (let i = 0; i < maxIterations; i++) {
                const midRate = (lowRate + highRate) / 2;
                if (Math.abs(highRate - lowRate) < tolerance) {
                    return midRate;
                }

                const currentNpv = npv(midRate);

                if (npvLow * currentNpv < 0) {
                    highRate = midRate;
                    npvHigh = currentNpv;
                } else {
                    lowRate = midRate;
                    npvLow = currentNpv;
                }
            }
            return (lowRate + highRate) / 2;
        }


        // --- Main Calculation Function ---
        function calculateLoan() {
            const loanAmount = parseFloat(loanAmountSlider.value);
            const loanTermYears = parseFloat(loanTermSlider.value);
            const loanTermMonths = loanTermYears * 12;

            // Use current values from dashboard sliders (using their respective IDs)
            currentTNA = parseFloat(dashboardTNAInput.value);
            currentLTV = parseFloat(dashboardLTVInput.value);
            currentDTI = parseFloat(dashboardDTIInput.value);
            currentEscrituraPercentage = parseFloat(dashboardEscrituraPercentageInput.value);
            currentEscrituraMinUSD = parseFloat(dashboardEscrituraMinUSDInput.value);
            currentOriginationFeePercentage = parseFloat(dashboardOriginationFeePercentageInput.value);
            currentOriginationFeeMinUSD = parseFloat(dashboardOriginationFeeMinUSDInput.value);
            currentInsuranceLifePercentage = parseFloat(dashboardInsuranceLifeInput.value);
            currentMarkupLifePercentage = parseFloat(dashboardMarkupLifePercentageInput.value);
            currentInsuranceFirePercentage = parseFloat(dashboardInsuranceFireInput.value);
            currentMarkupFirePercentage = parseFloat(dashboardMarkupFirePercentageInput.value);
            currentServicingFeeUSD = parseFloat(dashboardServicingFeeInput.value);

            const annualTNA = currentTNA;
            const monthlyTNA = annualTNA / 12;
            const ltv = currentLTV;
            const dti = currentDTI;
            const IVA_RATE = 0.21;

            // --- 1. Calculate Monthly Payment (French Amortization) ---
            const monthlyPaymentPrincipalInterest = calculateFrenchMonthlyPayment(loanAmount, annualTNA, loanTermYears);

            // --- 2. Calculate Client's Total Origination Costs ---
            let escrituraCostsBeforeIVA = Math.max(
                loanAmount * currentEscrituraPercentage,
                currentEscrituraMinUSD
            );
            let originationFeeBeforeIVA = Math.max(
                loanAmount * currentOriginationFeePercentage,
                currentOriginationFeeMinUSD
            );
            const totalOriginationCosts = (escrituraCostsBeforeIVA + originationFeeBeforeIVA) * (1 + IVA_RATE);

            const netAmountReceived = loanAmount - totalOriginationCosts;

            // --- 3. Calculate Minimum Property Value (LTV) ---
            const minPropertyValue = loanAmount / ltv;

            // --- 4. Simulate payments and collect cash flows for CFTEA and BB's IRR ---
            let currentBalance = loanAmount;
            let thirdMonthlyPayment = 0;
            const cashFlowsForCFT = [];
            cashFlowsForCFT.push(netAmountReceived); // Initial disbursement (inflow to borrower for CFT)

            // Cash flows for BB's TIR calculation
            const cashFlowsForBB = [];
            // Initial outflow for BB: loan amount minus the specific origination fee BB charges/retains
            // This fee is 1.5% with a minimum of USD 1500, as per the user's specific instruction for BB's IRR.
            const bbSpecificOriginationFee = Math.max(loanAmount * 0.015, 1500);
            cashFlowsForBB.push(-(loanAmount - bbSpecificOriginationFee)); // BB gives out loan amount, but effectively keeps this fee

            globalAmortizationData = []; // Clear global data for fresh table
            globalBBCashFlowData = []; // Clear global data for fresh BB cash flow
            globalBBCashFlowData.push({
                date: '', // No date for initial disbursement
                type: "Desembolso Inicial",
                capital: '',
                intereses: '',
                servicingFee: '',
                markupIncendio: '',
                markupVida: '',
                total: -(loanAmount - bbSpecificOriginationFee) // Negative for outflow
            });

            amortizationTableBody.innerHTML = ''; // Clear previous table rows

            const today = new Date();
            let paymentDate = new Date(today.getFullYear(), today.getMonth() + 1, 5); // First payment on 5th of next month

            tempAmortizationDataForCFTEA = []; // Reinitialize here, outside the loop

            for (let i = 1; i <= loanTermMonths; i++) {
                const interestPayment = currentBalance * monthlyTNA;
                const capitalPayment = monthlyPaymentPrincipalInterest - interestPayment;

                const actualCapitalPayment = Math.min(capitalPayment, currentBalance);
                const actualInterestPayment = (i === loanTermMonths && currentBalance > 0) ? currentBalance * monthlyTNA : interestPayment;
                const actualMonthlyPaymentPrincipalInterest = actualCapitalPayment + actualInterestPayment;

                const lifeInsuranceBase = currentBalance * currentInsuranceLifePercentage;
                const lifeInsuranceMarkupAmount = lifeInsuranceBase * currentMarkupLifePercentage;
                const totalLifeInsurance = lifeInsuranceBase + lifeInsuranceMarkupAmount;

                const fireInsuranceBase = minPropertyValue * currentInsuranceFirePercentage;
                const fireInsuranceMarkupAmount = fireInsuranceBase * currentMarkupFirePercentage;
                const totalFireInsurance = fireInsuranceBase + fireInsuranceMarkupAmount;

                const servicingFee = currentServicingFeeUSD;

                const ivaOnInterests = interestPayment * IVA_RATE;
                const ivaOnServicingFee = servicingFee * IVA_RATE;
                const totalIVA = ivaOnInterests + ivaOnServicingFee;

                const totalMonthlyPayment = actualMonthlyPaymentPrincipalInterest + totalLifeInsurance + totalFireInsurance + servicingFee + totalIVA;

                if (i === 3) {
                    thirdMonthlyPayment = totalMonthlyPayment;
                }
                cashFlowsForCFT.push(-totalMonthlyPayment); // Each monthly payment is an outflow (negative) for CFT

                // Calculate BB's monthly inflow
                // Capital + Intereses + Servicing Fee + Markup Seguro Vida + Markup Seguro Incendio
                const bbMonthlyInflow = actualCapitalPayment + interestPayment + servicingFee + lifeInsuranceMarkupAmount + fireInsuranceMarkupAmount;
                cashFlowsForBB.push(bbMonthlyInflow); // BB receives these payments

                globalBBCashFlowData.push({
                    date: paymentDate.toLocaleDateString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                    type: `Pago Mes ${i}`,
                    capital: actualCapitalPayment,
                    intereses: interestPayment,
                    servicingFee: servicingFee,
                    markupIncendio: fireInsuranceMarkupAmount,
                    markupVida: lifeInsuranceMarkupAmount,
                    total: bbMonthlyInflow
                }); // Store for CSV

                currentBalance -= actualCapitalPayment;
                if (currentBalance < 0) currentBalance = 0;

                tempAmortizationDataForCFTEA.push({
                    cfteaCapitalPayment: actualCapitalPayment,
                    cfteaInterestPayment: interestPayment,
                    cfteaIvaOnInterests: ivaOnInterests,
                    cfteaLifeInsurance: totalLifeInsurance, // Use total client paid for CFTEA
                    cfteaFireInsurance: totalFireInsurance, // Use total client paid for CFTEA
                    cfteaServicingFee: servicingFee
                });

                // Store current row's data for CSV export and table display
                globalAmortizationData.push({
                    date: paymentDate.toLocaleDateString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                    loanNumber: i,
                    remainingBalance: currentBalance,
                    capitalPayment: actualCapitalPayment,
                    interestPayment: interestPayment,
                    lifeInsurance: totalLifeInsurance, // Client's total payment for life insurance
                    fireAndAdmin: totalFireInsurance + servicingFee, // Client's total payment for fire insurance + servicing fee
                    iva: totalIVA,
                    totalPayment: totalMonthlyPayment,
                    // Store individual components for CFTEA recalculation
                    cfteaCapitalPayment: actualCapitalPayment,
                    cfteaInterestPayment: interestPayment,
                    cfteaIvaOnInterests: ivaOnInterests,
                    cfteaLifeInsurance: totalLifeInsurance,
                    cfteaFireInsurance: totalFireInsurance,
                    cfteaServicingFee: servicingFee
                });

                // Create table row for amortization table
                const row = amortizationTableBody.insertRow();
                row.className = 'hover:bg-blue-50';

                const cell1 = row.insertCell(); cell1.textContent = paymentDate.toLocaleDateString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit' }); cell1.classList.add('text-center');
                const cell2 = row.insertCell(); cell2.textContent = i; cell2.classList.add('text-center');
                const cell3 = row.insertCell(); cell3.textContent = formatCurrency(currentBalance); cell3.classList.add('text-center');
                const cell4 = row.insertCell(); cell4.textContent = formatCurrency(actualCapitalPayment); cell4.classList.add('text-center');
                const cell5 = row.insertCell(); cell5.textContent = formatCurrency(interestPayment); cell5.classList.add('text-center');
                const cell6 = row.insertCell(); cell6.textContent = formatCurrency(totalLifeInsurance); cell6.classList.add('text-center'); // Display total life insurance paid by client
                const cell7 = row.insertCell(); cell7.textContent = formatCurrency(totalFireInsurance + servicingFee); cell7.classList.add('text-center'); // Display total fire insurance + servicing fee
                const cell8 = row.insertCell(); cell8.textContent = formatCurrency(totalIVA); cell8.classList.add('text-center');
                const cell9 = row.insertCell(); cell9.textContent = formatCurrency(totalMonthlyPayment); cell9.classList.add('text-center');

                paymentDate.setMonth(paymentDate.getMonth() + 1);
            }

            // --- 5. Calculate Minimum Monthly Income (DTI) ---
            const minMonthlyIncome = thirdMonthlyPayment / dti;

            // --- 6. Calculate CFT (Costo Financiero Total) using IRR ---
            let calculatedCFT = 0;
            if (netAmountReceived > 0 && loanTermMonths > 0) {
                const monthlyIRR_CFT = calculateIRR(cashFlowsForCFT);
                calculatedCFT = Math.pow(1 + monthlyIRR_CFT, 12) - 1;
            }

            // --- 7. Calculate CFTEA (sin gastos de otorgamiento) using IRR ---
            let calculatedCFTEA = 0;
            const cfteaCashFlowsRecalculated = [];
            cfteaCashFlowsRecalculated.push(loanAmount); // Initial inflow for CFTEA (principal only)

            tempAmortizationDataForCFTEA.forEach(row => {
                const monthlyOutflowForCFTEA = row.cfteaCapitalPayment + row.cfteaInterestPayment + row.cfteaIvaOnInterests + row.cfteaLifeInsurance + row.cfteaFireInsurance + row.cfteaServicingFee;
                cfteaCashFlowsRecalculated.push(-monthlyOutflowForCFTEA);
            });

            if (loanAmount > 0 && loanTermMonths > 0) {
                const monthlyIRR_CFTEA = calculateIRR(cfteaCashFlowsRecalculated);
                calculatedCFTEA = Math.pow(1 + monthlyIRR_CFTEA, 12) - 1;
            }

            // --- Calculate BB's TIR ---
            let annualIRR_BB = 0;
            if (cashFlowsForBB.length > 1) { // Ensure there's at least an initial outflow and one inflow
                const monthlyIRR_BB = calculateIRR(cashFlowsForBB);
                annualIRR_BB = Math.pow(1 + monthlyIRR_BB, 12) - 1;
            }


            // --- 8. Update UI ---
            loanAmountValueSpan.textContent = formatCurrency(loanAmount);
            loanTermValueSpan.textContent = `${loanTermYears} Años`;

            monthlyPaymentSpan.textContent = formatCurrency(thirdMonthlyPayment);
            minMonthlyIncomeSpan.textContent = formatCurrency(minMonthlyIncome);
            minPropertyValueSpan.textContent = formatCurrency(minPropertyValue);
            cfteaWithoutOriginationSpan.textContent = formatPercentage(calculatedCFTEA);

            totalLoanAmountSpan.textContent = formatCurrency(loanAmount); // Corrected to display loanAmount
            originationCostsSpan.textContent = formatCurrency(totalOriginationCosts);
            cftWithOriginationDisplay.textContent = formatPercentage(calculatedCFT);
            tnaDisplaySpan.textContent = formatPercentage(annualTNA);

            // Update dashboard input values
            dashboardTNAInput.value = currentTNA;
            dashboardLTVInput.value = currentLTV;
            dashboardDTIInput.value = currentDTI;
            dashboardEscrituraPercentageInput.value = currentEscrituraPercentage;
            dashboardEscrituraMinUSDInput.value = currentEscrituraMinUSD;
            dashboardOriginationFeePercentageInput.value = currentOriginationFeePercentage;
            dashboardOriginationFeeMinUSDInput.value = currentOriginationFeeMinUSD;
            dashboardInsuranceLifeInput.value = currentInsuranceLifePercentage;
            dashboardMarkupLifePercentageInput.value = currentMarkupLifePercentage;
            dashboardInsuranceFireInput.value = currentInsuranceFirePercentage;
            dashboardMarkupFirePercentageInput.value = currentMarkupFirePercentage;
            dashboardServicingFeeInput.value = currentServicingFeeUSD;

            bbTIRValue.textContent = formatPercentage(annualIRR_BB); // Update BB's TIR
            cftWithOriginationDisplayPanel.textContent = formatPercentage(calculatedCFT); // Update CFTEA in panel
        }

        /**
         * Generates and downloads a CSV file with the full amortization table.
         */
        function downloadAmortizationCsv() {
            if (globalAmortizationData.length === 0) {
                console.log('No hay datos en el cuadro de amortización para descargar. Por favor, realiza una simulación primero.');
                return;
            }

            let csvContent = "Fecha de Pago,Nro. Cuota,Saldo Deudor,Pago Capital,Pago Intereses,Seguro Vida,Seguro Incendio y Admin.,IVA,Pago Total\n";

            globalAmortizationData.forEach(row => {
                const formattedRow = [
                    row.date,
                    row.loanNumber,
                    Math.ceil(row.remainingBalance),
                    Math.ceil(row.capitalPayment),
                    Math.ceil(row.interestPayment),
                    Math.ceil(row.lifeInsurance),
                    Math.ceil(row.fireAndAdmin),
                    Math.ceil(row.iva),
                    Math.ceil(row.totalPayment)
                ].join(',');
                csvContent += formattedRow + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'cuadro_amortizacion.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                document.body.removeChild(link);
            } else {
                console.log('Tu navegador no soporta la descarga directa. Copia el siguiente texto y pégalo en un archivo .csv:\n\n' + csvContent);
            }
        }

        /**
         * Generates and downloads a CSV file with BB's cash flow data.
         */
        function downloadBBCashFlowCsv() {
            if (globalBBCashFlowData.length === 0) {
                console.log('No hay datos del flujo de pagos de BB para descargar. Por favor, realiza una simulación primero.');
                return;
            }

            let csvContent = "Fecha de Pago,Tipo de Flujo,Pago Capital,Pago Intereses,Servicing Fee,Markup Seguro Incendio,Markup Seguro Vida,Pago Total\n";
            globalBBCashFlowData.forEach(flow => {
                // Ensure numeric values are rounded for CSV, empty strings for non-applicable fields
                const formattedRow = [
                    flow.date || '',
                    flow.type,
                    flow.capital !== undefined ? Math.ceil(flow.capital) : '',
                    flow.intereses !== undefined ? Math.ceil(flow.intereses) : '',
                    flow.servicingFee !== undefined ? Math.ceil(flow.servicingFee) : '',
                    flow.markupIncendio !== undefined ? Math.ceil(flow.markupIncendio) : '',
                    flow.markupVida !== undefined ? Math.ceil(flow.markupVida) : '',
                    Math.ceil(flow.total) // Total should always be present
                ].join(',');
                csvContent += formattedRow + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'flujo_pagos_bb.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                document.body.removeChild(link);
            } else {
                console.log('Tu navegador no soporta la descarga directa. Copia el siguiente texto y pégalo en un archivo .csv:\n\n' + csvContent);
            }
        }


        // Initial setup when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Assign DOM elements here
            loanAmountSlider = document.getElementById('loanAmount');
            loanAmountValueSpan = document.getElementById('loanAmountValue');
            loanTermSlider = document.getElementById('loanTerm');
            loanTermValueSpan = document.getElementById('loanTermValue');

            monthlyPaymentSpan = document.getElementById('monthlyPayment');
            minMonthlyIncomeSpan = document.getElementById('minMonthlyIncome');
            minPropertyValueSpan = document.getElementById('minPropertyValue');
            cfteaWithoutOriginationSpan = document.getElementById('cfteaWithoutOrigination');
            cftWithOriginationDisplay = document.getElementById('cftWithOriginationDisplay'); // Client's CFTEA with origination costs

            totalLoanAmountSpan = document.getElementById('totalLoanAmount');
            originationCostsSpan = document.getElementById('originationCosts');
            originationCostsDisplay = document.getElementById('originationCostsDisplay');
            tnaDisplaySpan = document.getElementById('tnaDisplay');

            amortizationTableBody = document.getElementById('amortizationTableBody');

            toggleDashboardBottomButton = document.getElementById('toggleDashboardBottom');
            dashboardContentBottom = document.getElementById('dashboardContentBottom');

            // Dashboard inputs and sliders
            dashboardTNASlider = document.getElementById('dashboardTNA');
            dashboardTNAInput = document.getElementById('dashboardTNAInput');
            dashboardTNAValueDisplay = document.getElementById('dashboardTNAValueDisplay'); // Added

            dashboardLTVSlider = document.getElementById('dashboardLTV');
            dashboardLTVInput = document.getElementById('dashboardLTVInput');
            dashboardLTVValueDisplay = document.getElementById('dashboardLTVValueDisplay'); // Added

            dashboardDTISlider = document.getElementById('dashboardDTI');
            dashboardDTIInput = document.getElementById('dashboardDTIInput');
            dashboardDTIValueDisplay = document.getElementById('dashboardDTIValueDisplay'); // Added

            dashboardEscrituraPercentage = document.getElementById('dashboardEscrituraPercentage');
            dashboardEscrituraPercentageInput = document.getElementById('dashboardEscrituraPercentageInput');
            dashboardEscrituraPercentageValueDisplay = document.getElementById('dashboardEscrituraPercentageValueDisplay'); // Added

            dashboardEscrituraMinUSD = document.getElementById('dashboardEscrituraMinUSD');
            dashboardEscrituraMinUSDInput = document.getElementById('dashboardEscrituraMinUSDInput');
            dashboardEscrituraMinUSDValueDisplay = document.getElementById('dashboardEscrituraMinUSDValueDisplay'); // Added

            dashboardOriginationFeePercentage = document.getElementById('dashboardOriginationFeePercentage');
            dashboardOriginationFeePercentageInput = document.getElementById('dashboardOriginationFeePercentageInput');
            dashboardOriginationFeePercentageValueDisplay = document.getElementById('dashboardOriginationFeePercentageValueDisplay'); // Added

            dashboardOriginationFeeMinUSD = document.getElementById('dashboardOriginationFeeMinUSD');
            dashboardOriginationFeeMinUSDInput = document.getElementById('dashboardOriginationFeeMinUSDInput');
            dashboardOriginationFeeMinUSDValueDisplay = document.getElementById('dashboardOriginationFeeMinUSDValueDisplay'); // Added

            dashboardInsuranceLifeSlider = document.getElementById('dashboardInsuranceLife');
            dashboardInsuranceLifeInput = document.getElementById('dashboardInsuranceLifeInput');
            dashboardInsuranceLifeValueDisplay = document.getElementById('dashboardInsuranceLifeValueDisplay'); // Added

            dashboardMarkupLifePercentage = document.getElementById('dashboardMarkupLifePercentage');
            dashboardMarkupLifePercentageInput = document.getElementById('dashboardMarkupLifePercentageInput');
            dashboardMarkupLifePercentageValueDisplay = document.getElementById('dashboardMarkupLifePercentageValueDisplay'); // Added

            dashboardInsuranceFireSlider = document.getElementById('dashboardInsuranceFire');
            dashboardInsuranceFireInput = document.getElementById('dashboardInsuranceFireInput');
            dashboardInsuranceFireValueDisplay = document.getElementById('dashboardInsuranceFireValueDisplay'); // Added

            dashboardMarkupFirePercentage = document.getElementById('dashboardMarkupFirePercentage');
            dashboardMarkupFirePercentageInput = document.getElementById('dashboardMarkupFirePercentageInput');
            dashboardMarkupFirePercentageValueDisplay = document.getElementById('dashboardMarkupFirePercentageValueDisplay'); // Added

            dashboardServicingFeeSlider = document.getElementById('dashboardServicingFee');
            dashboardServicingFeeInput = document.getElementById('dashboardServicingFeeInput');
            dashboardServicingFeeValueDisplay = document.getElementById('dashboardServicingFeeValueDisplay'); // Added

            toggleAmortizationTableButton = document.getElementById('toggleAmortizationTable');
            amortizationTableSection = document.getElementById('amortizationTableSection');
            amortizationTableTitle = document.getElementById('amortizationTableTitle');
            downloadAmortizationCsvBtn = document.getElementById('downloadAmortizationCsvBtn');

            bbTIRValue = document.getElementById('bbTIRValue');
            downloadBBCashFlowCsvBtn = document.getElementById('downloadBBCashFlowCsvBtn');
            cftWithOriginationDisplayPanel = document.getElementById('cftWithOriginationDisplayPanel'); // Get reference to CFTEA in panel

            // Set default loan amount to 100,000 USD and loan term to 10 years
            loanAmountSlider.value = 100000;
            loanTermSlider.value = 10;

            // Attach event listeners after elements are assigned
            loanAmountSlider.addEventListener('input', calculateLoan);
            loanTermSlider.addEventListener('input', calculateLoan);

            // Event listeners for dashboard sliders and inputs
            const dashboardControls = [
                { slider: dashboardTNASlider, input: dashboardTNAInput, display: dashboardTNAValueDisplay, type: 'percentage' },
                { slider: dashboardLTVSlider, input: dashboardLTVInput, display: dashboardLTVValueDisplay, type: 'percentage' },
                { slider: dashboardDTISlider, input: dashboardDTIInput, display: dashboardDTIValueDisplay, type: 'percentage' },
                { slider: dashboardEscrituraPercentage, input: dashboardEscrituraPercentageInput, display: dashboardEscrituraPercentageValueDisplay, type: 'percentage' },
                { slider: dashboardEscrituraMinUSD, input: dashboardEscrituraMinUSDInput, display: dashboardEscrituraMinUSDValueDisplay, type: 'currency' },
                { slider: dashboardOriginationFeePercentage, input: dashboardOriginationFeePercentageInput, display: dashboardOriginationFeePercentageValueDisplay, type: 'percentage' },
                { slider: dashboardOriginationFeeMinUSD, input: dashboardOriginationFeeMinUSDInput, display: dashboardOriginationFeeMinUSDValueDisplay, type: 'currency' },
                { slider: dashboardInsuranceLifeSlider, input: dashboardInsuranceLifeInput, display: dashboardInsuranceLifeValueDisplay, type: 'percentage' },
                { slider: dashboardMarkupLifePercentage, input: dashboardMarkupLifePercentageInput, display: dashboardMarkupLifePercentageValueDisplay, type: 'percentage' },
                { slider: dashboardInsuranceFireSlider, input: dashboardInsuranceFireInput, display: dashboardInsuranceFireValueDisplay, type: 'percentage' },
                { slider: dashboardMarkupFirePercentage, input: dashboardMarkupFirePercentageInput, display: dashboardMarkupFirePercentageValueDisplay, type: 'percentage' },
                { slider: dashboardServicingFeeSlider, input: dashboardServicingFeeInput, display: dashboardServicingFeeValueDisplay, type: 'currency' }
            ];

            dashboardControls.forEach(control => {
                const updateDisplay = () => {
                    const value = parseFloat(control.input.value);
                    if (control.type === 'percentage') {
                        control.display.textContent = formatPercentage(value);
                    } else if (control.type === 'currency') {
                        control.display.textContent = formatCurrency(value);
                    }
                };

                control.slider.addEventListener('input', (event) => {
                    control.input.value = event.target.value;
                    updateDisplay();
                    calculateLoan();
                });

                control.input.addEventListener('input', (event) => {
                    // Ensure the input value is within the slider's min/max range
                    let value = parseFloat(event.target.value);
                    if (isNaN(value)) value = parseFloat(control.slider.min); // Default to min if not a number
                    if (value < parseFloat(control.slider.min)) value = parseFloat(control.slider.min);
                    if (value > parseFloat(control.slider.max)) value = parseFloat(control.slider.max);
                    
                    control.slider.value = value;
                    event.target.value = value; // Update input field with clamped value
                    
                    updateDisplay();
                    calculateLoan();
                });

                // Initial formatting and display update for inputs
                if (control.type === 'percentage') {
                    control.input.value = parseFloat(control.input.value).toFixed(4);
                } else if (control.type === 'currency') {
                    control.input.value = parseFloat(control.input.value).toFixed(0);
                } else if (control.input.id === 'dashboardLTVInput' || control.input.id === 'dashboardDTIInput' || control.input.id === 'dashboardTNAInput') {
                    control.input.value = parseFloat(control.input.value).toFixed(3);
                }
                updateDisplay(); // Call initially to set the display span text
            });


            toggleDashboardBottomButton.addEventListener('click', () => {
                dashboardContentBottom.classList.toggle('collapsed');
                toggleDashboardBottomButton.querySelector('svg').classList.toggle('rotated');
            });

            toggleAmortizationTableButton.addEventListener('click', () => {
                amortizationTableSection.classList.toggle('collapsed');
                amortizationTableTitle.style.display = amortizationTableSection.classList.contains('collapsed') ? 'none' : 'block';
                if (amortizationTableSection.classList.contains('collapsed')) {
                    toggleAmortizationTableButton.textContent = 'Ver Cuadro de Amortización Completo';
                } else {
                    toggleAmortizationTableButton.textContent = 'Ocultar Cuadro de Amortización';
                }
            });

            downloadAmortizationCsvBtn.addEventListener('click', downloadAmortizationCsv);
            downloadBBCashFlowCsvBtn.addEventListener('click', downloadBBCashFlowCsv);

            calculateLoan(); // Perform initial calculation
            console.log("Simulador cargado y cálculos iniciales realizados.");
        });
    </script>
</body>
</html>

